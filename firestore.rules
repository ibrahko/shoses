/**
 * @file firestore.rules
 * @description Security rules for the SneakerVerse Firestore database.
 *
 * @section Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user-specific data,
 * such as addresses, shopping carts, and orders, is stored in subcollections
 * under that user's unique document. This ensures that users can only ever
 * access their own information. The global product catalog is public for reading
 * but is write-protected.
 *
 * @section Data Structure
 * The data is organized hierarchically to reflect ownership:
 * - /users/{userId} -> User profile and root for all personal data.
 * - /users/{userId}/addresses/{addressId} -> User's saved addresses.
 * - /users/{userId}/shoppingCartItems/{cartItemId} -> User's current shopping cart.
 * - /users/{userId}/orders/{orderId} -> User's past orders.
 * - /products/{productId} -> A top-level collection for the public product catalog.
 *
 * @section Key Security Decisions
 * - User Isolation: A user's access is strictly confined to their own data tree
 *   (i.e., documents and subcollections under `/users/{their_own_userId}`).
 * - No User Listing: It is forbidden to query or list the top-level `/users`
 *   collection to protect user privacy.
 * - Public Catalog, Private Writes: The `/products` collection is publicly readable by
 *   anyone, but all write operations (create, update, delete) are disabled. This
 *   assumes products are managed by a backend admin process, not client-side users.
 * - Read-Only Recommendations: Recommendations are considered read-only for the user.
 *   They can be read by the user they are intended for, but cannot be created,
 *   modified, or deleted by them.
 *
 * @section Denormalization & Structural Segregation
 * This ruleset relies on the "Structural Segregation" pattern. Private user data
 * (like `/users/{userId}/orders`) is in a completely separate collection tree from
 * public data (`/products`). This makes rules simpler, more secure, and allows for
 * efficient, safe list queries without complex filters. Path-based security is
t * used throughout, which is fast and avoids costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner and the document already exists.
     * Used to protect update and delete operations from acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the incoming document's `id` field matches the document's ID from the path.
     * Enforces relational integrity on document creation.
     */
    function hasMatchingId(docId) {
      return request.resource.data.id == docId;
    }

    /**
     * Validates that the incoming document's `userId` field matches the owner's UID from the path.
     * Enforces that user-owned sub-collection items correctly reference their owner.
     */
    function hasCorrectUserId(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * Validates that the incoming document's `orderId` field matches the order's ID from the path.
     * Enforces that order items correctly reference their parent order.
     */
    function hasCorrectOrderId(orderId) {
      return request.resource.data.orderId == orderId;
    }

    /**
     * Enforces immutability of a document's `id` field during an update.
     */
    function isIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }
    
    /**
     * Enforces immutability of a document's `userId` field during an update.
     */
    function isUserIdImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    /**
     * Enforces immutability of a document's `orderId` field during an update.
     */
    function isOrderIdImmutable() {
      return request.resource.data.orderId == resource.data.orderId;
    }


    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own user profile document.
     * @deny (list) An authenticated user trying to list all users in the system.
     * @principle A user can manage their own profile, but cannot see other users.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users for privacy
      allow create: if isOwner(userId) && hasMatchingId(userId);
      allow update: if isExistingOwner(userId) && isIdImmutable();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages a user's address documents.
       * @path /users/{userId}/addresses/{addressId}
       * @allow (create) An authenticated user adding a new address for themselves.
       * @deny (get) An authenticated user trying to read another user's address.
       * @principle Restricts access to a user's own data tree.
       */
      match /addresses/{addressId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasMatchingId(addressId);
        allow update: if isExistingOwner(userId) && isIdImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages items in a user's shopping cart.
       * @path /users/{userId}/shoppingCartItems/{cartItemId}
       * @allow (list) An authenticated user listing the items in their own cart.
       * @deny (create) An authenticated user trying to add an item to another user's cart.
       * @principle Restricts access to a user's own data tree.
       */
      match /shoppingCartItems/{cartItemId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasCorrectUserId(userId);
        allow update: if isExistingOwner(userId) && isUserIdImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages a user's orders.
       * @path /users/{userId}/orders/{orderId}
       * @allow (get) An authenticated user viewing one of their own past orders.
       * @deny (update) An authenticated user trying to modify another user's order.
       * @principle Restricts access to a user's own data tree.
       */
      match /orders/{orderId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasCorrectUserId(userId);
        allow update: if isExistingOwner(userId) && isUserIdImmutable();
        allow delete: if isExistingOwner(userId);

        /**
         * @description Manages the individual items within a specific order.
         * @path /users/{userId}/orders/{orderId}/orderItems/{orderItemId}
         * @allow (get) An authenticated user viewing an item within their own order.
         * @deny (get) An authenticated user trying to view an item in someone else's order.
         * @principle Access is inherited from the parent document's ownership rules.
         */
        match /orderItems/{orderItemId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && hasCorrectOrderId(orderId);
          allow update: if isExistingOwner(userId) && isOrderIdImmutable();
          allow delete: if isExistingOwner(userId);
        }
      }

      /**
       * @description Manages recommendations for a user. These are read-only for the client.
       * @path /users/{userId}/recommendations/{recommendationId}
       * @allow (get, list) An authenticated user viewing their own recommendations.
       * @deny (create, update, delete) A user trying to create or modify their own recommendations.
       * @principle Data is read-only for the owner; writes must be performed by a trusted backend.
       */
      match /recommendations/{recommendationId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if false; // Recommendations are generated by the backend
        allow update: if false;
        allow delete: if false;
      }
    }
    
    /**
     * @description Manages the public product catalog.
     * @path /products/{productId}
     * @allow (get, list) Any user, authenticated or not, can view products.
     * @deny (create, update, delete) All write operations are forbidden from the client.
     * @principle Data is public-read. Writes must be performed by a trusted backend process.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // Products are managed by an admin backend, not clients
      allow update: if false;
      allow delete: if false;
    }
  }
}